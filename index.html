<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• T·∫°o Th√¥ng B√°o & Nh·∫≠n X√©t Th√¥ng Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-btn.active {
            border-color: #3B82F6;
            color: #3B82F6;
            background-color: #EFF6FF;
        }
        .dark .tab-btn.active {
            border-color: #60A5FA;
            color: #60A5FA;
            background-color: #1F2937;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366F1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #customAlert {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(calc(100% + 20px));
            opacity: 0;
        }
        #customAlert.show {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8">
            
            <div class="text-center mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400">C√¥ng C·ª• T·∫°o Th√¥ng B√°o & Nh·∫≠n X√©t</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Ch·ªçn lo·∫°i vƒÉn b·∫£n v√† ƒëi·ªÅn th√¥ng tin ƒë·ªÉ t·∫°o nhanh ch√≥ng.</p>
            </div>

            <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                <nav class="-mb-px flex space-x-1 sm:space-x-4 overflow-x-auto" aria-label="Tabs">
                    <button id="tabBtnLecture" class="tab-btn active whitespace-nowrap py-3 px-2 sm:px-4 border-b-2 font-medium text-sm">
                        Th√¥ng b√°o b√†i gi·∫£ng
                    </button>
                    <button id="tabBtnHomework" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        Nh·∫Øc nh·ªü b√†i t·∫≠p
                    </button>
                    <button id="tabBtnFeedback" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        Nh·∫≠n x√©t bu·ªïi h·ªçc
                    </button>
                    <button id="tabBtnUpdate" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        Update b√†i gi·∫£ng
                    </button>
                    <button id="tabBtnCheckHw" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        Check b√†i t·∫≠p
                    </button>
                    <button id="tabBtnLowScore" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        ƒêi·ªÉm th·∫•p
                    </button>
                </nav>
            </div>

            <!-- Tab Content: Lecture Announcement -->
            <div id="tabContentLecture" class="tab-content active fade-in">
                <div class="space-y-6">
                    <div>
                        <label for="classInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">L·ªõp h·ªçc</label>
                        <select id="classInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            <option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option>
                        </select>
                    </div>
                    <div>
                        <label for="subjectInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">M√¥n h·ªçc</label>
                        <select id="subjectInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            <option value="v·∫≠t l√≠">V·∫≠t l√≠</option><option value="h√≥a h·ªçc">H√≥a h·ªçc</option><option value="sinh h·ªçc" selected>Sinh h·ªçc</option>
                        </select>
                    </div>
                    <div>
                        <label for="lessonInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">T√™n b√†i h·ªçc</label>
                        <input type="text" id="lessonInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" value="KH√ÅI QU√ÅT V·ªÄ C∆† TH·ªÇ NG∆Ø·ªúI" required>
                    </div>
                    <div>
                        <label for="linkInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link b√†i gi·∫£ng</label>
                        <input type="url" id="linkInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" value="https://thaylamphysics.github.io/bio8-20250725/" required>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="generateBtnLecture" class="w-full sm:w-auto text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800 transition-transform transform hover:scale-105">T·∫°o th√¥ng b√°o b√†i gi·∫£ng</button>
                </div>
            </div>

            <!-- Tab Content: Homework Reminder -->
            <div id="tabContentHomework" class="tab-content fade-in">
                <div class="space-y-6">
                    <div>
                        <label for="hwSubjectInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">M√¥n h·ªçc</label>
                        <select id="hwSubjectInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            <option value="v·∫≠t l√≠">V·∫≠t l√≠</option><option value="h√≥a h·ªçc" selected>H√≥a h·ªçc</option><option value="sinh h·ªçc">Sinh h·ªçc</option><option value="3 ph√¢n m√¥n">3 ph√¢n m√¥n</option>
                        </select>
                    </div>
                    <div id="singleSubjectDetails">
                        <label for="hwQuestionsInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">S·ªë c√¢u b√†i t·∫≠p</label>
                        <input type="number" id="hwQuestionsInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" value="20" required>
                    </div>
                    <div id="multiSubjectDetails" class="space-y-4" style="display: none;">
                        <div>
                            <label for="hwPhysicsInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">N·ªôi dung b√†i t·∫≠p L√Ω</label>
                            <textarea id="hwPhysicsInput" rows="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: Ho√†n th√†nh 15 c√¢u tr·∫Øc nghi·ªám ch∆∞∆°ng 1"></textarea>
                        </div>
                        <div>
                            <label for="hwChemistryInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">N·ªôi dung b√†i t·∫≠p H√≥a</label>
                            <textarea id="hwChemistryInput" rows="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: L√†m 5 b√†i t·∫≠p t·ª± lu·∫≠n v·ªÅ chu·ªói ph·∫£n ·ª©ng"></textarea>
                        </div>
                        <div>
                            <label for="hwBiologyInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">N·ªôi dung b√†i t·∫≠p Sinh</label>
                            <textarea id="hwBiologyInput" rows="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: V·∫Ω s∆° ƒë·ªì t∆∞ duy b√†i 2"></textarea>
                        </div>
                    </div>
                    <div>
                        <label for="hwDeadlineInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">H·∫°n n·ªôp</label>
                        <input type="date" id="hwDeadlineInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                    </div>
                    <div>
                        <label for="hwLinkInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link b√†i t·∫≠p v·ªÅ nh√†</label>
                        <input type="url" id="hwLinkInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" value="https://thaylamphysics.github.io/hwchem8-20250804/" required>
                    </div>
                    <div>
                        <label for="hwNoteInput" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">L∆∞u √Ω quan tr·ªçng</label>
                        <textarea id="hwNoteInput" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">nh·ªØng c√¢u t√≠nh to√°n c√°c b·∫°n c·∫ßn ph·∫£i tr√¨nh b√†y ra v·ªü ƒë·ªÉ ch·∫•m v√† ch√∫ng m√¨nh l√†m b√†i ghi ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† ch·ªØ c√°i ƒë·∫ßu vi·∫øt hoa nha!!!</textarea>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="generateBtnHomework" class="w-full sm:w-auto text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800 transition-transform transform hover:scale-105">T·∫°o th√¥ng b√°o b√†i t·∫≠p</button>
                </div>
            </div>

            <!-- Tab Content: Session Feedback (REBUILT) -->
            <div id="tabContentFeedback" class="tab-content fade-in">
                <div class="space-y-6">
                    <!-- Step 1: Basic Info -->
                    <div id="fb-step1">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">B∆∞·ªõc 1: Th√¥ng tin c∆° b·∫£n</h3>
                        <div class="space-y-4">
                            <!-- Gemini API Key input field is now hidden -->
                            <div style="display: none;">
                                <label for="geminiApiKey" class="block mb-2 text-sm font-medium">Gemini API Key</label>
                                <input type="password" id="geminiApiKey" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y" required>
                            </div>
                            <div>
                                <label for="fbSubject" class="block mb-2 text-sm font-medium">M√¥n h·ªçc</label>
                                <input type="text" id="fbSubject" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" value="H√≥a" required>
                            </div>
                            <div>
                                <label for="fbLesson" class="block mb-2 text-sm font-medium">T√™n b√†i h·ªçc</label>
                                <input type="text" id="fbLesson" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" value="C√¢n b·∫±ng ph∆∞∆°ng tr√¨nh" required>
                            </div>
                            <div>
                                <label for="fbSheetLink" class="block mb-2 text-sm font-medium">Link Google Sheet (b·∫£ng ƒëi·ªÉm)</label>
                                <input type="url" id="fbSheetLink" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="D√°n link file ƒëi·ªÉm c·ªßa bu·ªïi h·ªçc" required>
                            </div>
                            <div class="text-right">
                                <button id="btnLoadSheetData" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 inline-flex items-center">
                                    <span id="loadBtnText">T·∫£i th√¥ng tin Sheet</span>
                                    <div id="loadLoader" class="loader ml-2" style="display: none;"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Select Sheet and Columns -->
                    <div id="fb-step2" class="hidden space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">B∆∞·ªõc 2: Ch·ªçn d·ªØ li·ªáu ph√¢n t√≠ch</h3>
                        <div>
                            <label for="fbSheetSelect" class="block mb-2 text-sm font-medium">Ch·ªçn Sheet ch·ª©a ƒëi·ªÉm</label>
                            <select id="fbSheetSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="fbNameColumnSelect" class="block mb-2 text-sm font-medium">C·ªôt T√™n h·ªçc sinh</label>
                                <select id="fbNameColumnSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                            <div>
                                <label for="fbScoreColumnSelect" class="block mb-2 text-sm font-medium">C·ªôt S·ªë c√¢u ƒë√∫ng</label>
                                <select id="fbScoreColumnSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                            <div>
                                <label for="fbTotalQuestionsColumnSelect" class="block mb-2 text-sm font-medium">C·ªôt T·ªïng s·ªë c√¢u</label>
                                <select id="fbTotalQuestionsColumnSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                        </div>
                        <div class="flex items-center mt-4">
                            <input type="checkbox" id="fbUseAI" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            <label for="fbUseAI" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">S·ª≠ d·ª•ng AI ƒë·ªÉ nh·∫≠n x√©t chi ti·∫øt h∆°n</label>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="generateBtnFeedback" class="w-full sm:w-auto text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-6 py-3 text-center inline-flex items-center disabled:bg-gray-400" disabled>
                        <span id="feedbackBtnText">Ph√¢n t√≠ch v√† t·∫°o nh·∫≠n x√©t</span>
                        <div id="feedbackLoader" class="loader ml-3" style="display: none;"></div>
                    </button>
                </div>
            </div>

            <!-- Tab Content: Update Lecture -->
            <div id="tabContentUpdate" class="tab-content fade-in">
                <div class="space-y-6">
                    <div>
                        <label for="updateClass" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">L·ªõp</label>
                        <select id="updateClass" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            <option value="8">L·ªõp 8</option>
                            <option value="9">L·ªõp 9</option>
                        </select>
                    </div>
                    <div>
                        <label for="updateSubject" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">M√¥n h·ªçc</label>
                        <select id="updateSubject" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            <option value="V·∫¨T L√ç">V·∫¨T L√ç</option>
                            <option value="H√ìA H·ªåC">H√ìA H·ªåC</option>
                            <option value="SINH H·ªåC">SINH H·ªåC</option>
                        </select>
                    </div>
                    <div>
                        <label for="updateContent" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">N·ªôi dung b√†i gi·∫£ng</label>
                        <textarea id="updateContent" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: C√¢n b·∫±ng ph∆∞∆°ng tr√¨nh v√† b·∫£o to√†n kh·ªëi l∆∞·ª£ng" required></textarea>
                    </div>
                    <div>
                        <label for="updateDate" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Ng√†y h·ªçc</label>
                        <input type="date" id="updateDate" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                    </div>
                    <div>
                        <label for="updateLectureLink" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link b√†i gi·∫£ng</label>
                        <input type="url" id="updateLectureLink" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                    </div>
                    <div>
                        <label for="updateVideoLink" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link video b√†i gi·∫£ng (T√πy ch·ªçn)</label>
                        <input type="url" id="updateVideoLink" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                    </div>
                    <div>
                        <label for="updateHomeworkLink" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link b√†i t·∫≠p v·ªÅ nh√† (T√πy ch·ªçn)</label>
                        <input type="url" id="updateHomeworkLink" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="btnUpdateLecture" class="w-full sm:w-auto text-white bg-teal-600 hover:bg-teal-700 focus:ring-4 focus:outline-none focus:ring-teal-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-teal-500 dark:hover:bg-teal-600 dark:focus:ring-teal-800 transition-transform transform hover:scale-105 inline-flex items-center disabled:bg-gray-400">
                        <span id="updateBtnText">Up b√†i gi·∫£ng</span>
                        <div id="updateLoader" class="loader ml-3" style="display: none;"></div>
                    </button>
                </div>
            </div>

            <!-- Tab Content: Check Homework -->
            <div id="tabContentCheckHw" class="tab-content fade-in">
                <div class="space-y-6">
                    <div>
                        <label for="checkHwClassSelect" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Ch·ªçn l·ªõp ƒë·ªÉ ki·ªÉm tra</label>
                        <select id="checkHwClassSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" disabled>
                            <option>ƒêang t·∫£i danh s√°ch l·ªõp...</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Danh s√°ch ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ª´ file d·ªØ li·ªáu c·ªßa b·∫°n.</p>
                    </div>
                    <div>
                        <label for="checkHwScoreSheet" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link Sheet ƒêi·ªÉm BTVN</label>
                        <input type="url" id="checkHwScoreSheet" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="D√°n link sheet ch·ª©a danh s√°ch ƒë√£ n·ªôp b√†i" required>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="btnCheckHw" class="w-full sm:w-auto text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-indigo-500 dark:hover:bg-indigo-600 dark:focus:ring-indigo-800 transition-transform transform hover:scale-105 inline-flex items-center disabled:bg-gray-400">
                        <span id="checkHwBtnText">Ki·ªÉm tra</span>
                        <div id="checkHwLoader" class="loader ml-3" style="display: none;"></div>
                    </button>
                </div>
            </div>
            
            <!-- Tab Content: Low Score -->
            <div id="tabContentLowScore" class="tab-content fade-in">
                <iframe id="lowScoreFrame" style="width: 100%; height: 1200px; border: none;" title="Ph√¢n t√≠ch h·ªçc sinh ƒëi·ªÉm th·∫•p"></iframe>
            </div>


            <!-- Result Section (Shared by all tabs) -->
            <div id="resultContainer" class="mt-10" style="display: none;">
                <div id="output"></div>
                <div id="copyMessage" class="mt-2 text-center text-green-600 dark:text-green-400 font-medium" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Toast Notification -->
    <div id="customAlert" class="fixed bottom-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center space-x-3 z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="customAlertMessage"></span>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Tab Handling ---
        const tabs = [
            { btn: document.getElementById('tabBtnLecture'), content: document.getElementById('tabContentLecture') },
            { btn: document.getElementById('tabBtnHomework'), content: document.getElementById('tabContentHomework') },
            { btn: document.getElementById('tabBtnFeedback'), content: document.getElementById('tabContentFeedback') },
            { btn: document.getElementById('tabBtnUpdate'), content: document.getElementById('tabContentUpdate') },
            { btn: document.getElementById('tabBtnCheckHw'), content: document.getElementById('tabContentCheckHw') },
            { btn: document.getElementById('tabBtnLowScore'), content: document.getElementById('tabContentLowScore') }
        ];
        tabs.forEach(tab => {
            tab.btn.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.btn.classList.remove('active');
                    t.content.classList.remove('active');
                });
                tab.btn.classList.add('active');
                tab.content.classList.add('active');
                resultContainer.style.display = 'none';

                if (tab.btn.id === 'tabBtnCheckHw') {
                    populateClassSelector();
                }
            });
        });

        const resultContainer = document.getElementById('resultContainer');
        const outputDiv = document.getElementById('output');
        const copyMessage = document.getElementById('copyMessage');
        const backendUrl = "https://script.google.com/macros/s/AKfycbw8pzZ0z_ANimfz5z0u_gtQXe6ZkGzOjJQV74a7SgBqbOihzocdJgjR2fa1F0eQZoMGMg/exec"; // This URL should point to your Google Apps Script deployment

        // --- IMPORTANT: Your Gemini API Key goes here ---
        // For local development or personal tools, you can place it directly.
        // For production apps, consider more secure methods (e.g., server-side environment variables).
        const GEMINI_API_KEY = "AIzaSyDXBkn0tzsUL22rLKfdRB7ZC7Vq4lOr6lI"; // Replace with your actual API Key

        // --- Custom Alert Function ---
        function showCustomAlert(message, type = 'info') {
            const alertBox = document.getElementById('customAlert');
            const alertMessage = document.getElementById('customAlertMessage');
            const alertIcon = alertBox.querySelector('svg');

            alertMessage.textContent = message;
            alertBox.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600');
            alertIcon.innerHTML = ''; // Clear existing icon

            if (type === 'success') {
                alertBox.classList.add('bg-green-600');
                alertIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'; // Checkmark
            } else if (type === 'error') {
                alertBox.classList.add('bg-red-600');
                alertIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'; // X-mark
            } else { // info
                alertBox.classList.add('bg-blue-600');
                alertIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'; // Info circle
            }

            alertBox.classList.add('show');

            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 3000);
        }

        // --- Helper function for copying text ---
        function copyToClipboard(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = button.innerHTML;
                button.innerHTML = 'ƒê√£ ch√©p!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 1500);
                showCustomAlert('ƒê√£ sao ch√©p v√†o clipboard!', 'success'); // Use custom alert
            } catch (err) {
                showCustomAlert('Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông.', 'error'); // Use custom alert
            }
            document.body.removeChild(textArea);
        }
        
        // Event delegation for copy buttons
        outputDiv.addEventListener('click', function(e) {
            if (e.target && e.target.matches('button.copy-btn')) {
                const textToCopy = e.target.dataset.copy;
                copyToClipboard(textToCopy, e.target);
            }
        });


        // --- Lecture Announcement Logic ---
        const generateBtnLecture = document.getElementById('generateBtnLecture');
        generateBtnLecture.addEventListener('click', () => {
            const classInput = document.getElementById('classInput');
            const subjectInput = document.getElementById('subjectInput');
            const lessonInput = document.getElementById('lessonInput');
            const linkInput = document.getElementById('linkInput');
            
            // Create a text-only version for clipboard
            const announcementText = `üì¢ TH√îNG B√ÅO G·ª¨I PH·ª§ HUYNH V√Ä H·ªåC SINH L·ªöP ${classInput.value.trim().toUpperCase()}
M·ªçi ng∆∞·ªùi ∆°i tu·∫ßn n√†y ch√∫ng ta s·∫Ω c√πng nhau t√¨m hi·ªÉu m√¥n ${subjectInput.value.trim()} qua b√†i : ${lessonInput.value.trim().toUpperCase()} nha!!!!
ƒê·ªÉ bu·ªïi h·ªçc m√¥n ${subjectInput.value.trim()} l·ªõp ${classInput.value.trim()} di·ªÖn ra hi·ªáu qu·∫£ v√† th√∫ v·ªã h∆°n, th·∫ßy mong c√°c em d√†nh ch√∫t th·ªùi gian xem tr∆∞·ªõc b√†i gi·∫£ng ·ªü nh√† theo h∆∞·ªõng d·∫´n ƒë√£ ƒë∆∞·ª£c giao.
Th·∫ßy gi√°o c≈©ng xin nh·ªù qu√Ω ph·ª• huynh nh·∫Øc nh·ªü con em m√¨nh ƒëi h·ªçc ƒë·∫ßy ƒë·ªß, ƒë√∫ng gi·ªù v√† ch·ªß ƒë·ªông chu·∫©n b·ªã b√†i v·ªü, m√°y t√≠nh ƒë·ªÉ vi·ªác h·ªçc b√†i tr·ªü n√™n nh·∫π nh√†ng v√† hi·ªáu qu·∫£ h∆°n.
link b√†i gi·∫£ng: ${linkInput.value.trim()}`;

            // Create HTML version for display
            const announcementHTML = `üì¢ TH√îNG B√ÅO G·ª¨I PH·ª§ HUYNH V√Ä H·ªåC SINH L·ªöP ${classInput.value.trim().toUpperCase()}
M·ªçi ng∆∞·ªùi ∆°i tu·∫ßn n√†y ch√∫ng ta s·∫Ω c√πng nhau t√¨m hi·ªÉu m√¥n ${subjectInput.value.trim()} qua b√†i : <strong style="color: #E53E3E;">${lessonInput.value.trim().toUpperCase()}</strong> nha!!!!
ƒê·ªÉ bu·ªïi h·ªçc m√¥n ${subjectInput.value.trim()} l·ªõp ${classInput.value.trim()} di·ªÖn ra hi·ªáu qu·∫£ v√† th√∫ v·ªã h∆°n, th·∫ßy mong c√°c em d√†nh ch√∫t th·ªùi gian xem tr∆∞·ªõc b√†i gi·∫£ng ·ªü nh√† theo h∆∞·ªõng d·∫´n ƒë√£ ƒë∆∞·ª£c giao.
Th·∫ßy gi√°o c≈©ng xin nh·ªù qu√Ω ph·ª• huynh nh·∫Øc nh·ªü con em m√¨nh ƒëi h·ªçc ƒë·∫ßy ƒë·ªß, ƒë√∫ng gi·ªù v√† ch·ªß ƒë·ªông chu·∫©n b·ªã b√†i v·ªü, m√°y t√≠nh ƒë·ªÉ vi·ªác h·ªçc b√†i tr·ªü n√™n nh·∫π nh√†ng v√† hi·ªáu qu·∫£ h∆°n.
link b√†i gi·∫£ng: <a href="${linkInput.value.trim()}" target="_blank" style="color: #3B82F6; text-decoration: underline;">${linkInput.value.trim()}</a>`;
            
            const resultTitle = `<div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">N·ªôi dung th√¥ng b√°o b√†i gi·∫£ng:</h2>
                <button class="copy-btn text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-4 py-2" data-copy="${announcementText}">Sao ch√©p</button>
            </div>`;
            outputDiv.innerHTML = resultTitle + `<div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 whitespace-pre-wrap text-sm">${announcementHTML}</div>`;
            resultContainer.style.display = 'block';
        });

        // --- Homework Reminder Logic ---
        const generateBtnHomework = document.getElementById('generateBtnHomework');
        const hwSubjectInput = document.getElementById('hwSubjectInput');
        const singleSubjectDetails = document.getElementById('singleSubjectDetails');
        const multiSubjectDetails = document.getElementById('multiSubjectDetails');
        const hwDeadlineInput = document.getElementById('hwDeadlineInput');
        
        const today = new Date();
        const nextWeek = new Date(new Date().setDate(today.getDate() + 6));
        hwDeadlineInput.value = nextWeek.toISOString().split('T')[0];

        hwSubjectInput.addEventListener('change', () => {
            singleSubjectDetails.style.display = hwSubjectInput.value === '3 ph√¢n m√¥n' ? 'none' : 'block';
            multiSubjectDetails.style.display = hwSubjectInput.value === '3 ph√¢n m√¥n' ? 'block' : 'none';
        });

        generateBtnHomework.addEventListener('click', () => {
            const subject = hwSubjectInput.value.trim();
            const deadlineDate = new Date(hwDeadlineInput.value);
            const formattedDeadline = deadlineDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const deadlineText = `tr∆∞·ªõc ng√†y ${formattedDeadline}`;
            let homeworkDetails = '';
            let homeworkDetailsText = '';

            if (subject === '3 ph√¢n m√¥n') {
                const physics = document.getElementById('hwPhysicsInput').value.trim();
                const chemistry = document.getElementById('hwChemistryInput').value.trim();
                const biology = document.getElementById('hwBiologyInput').value.trim();
                homeworkDetails = `Ch√∫ng ta tu·∫ßn n√†y s·∫Ω l√†m b√†i t·∫≠p v·ªÅ nh√† c·ªßa 3 ph√¢n m√¥n nh∆∞ sau:
- <strong style="color: #059669;">L√Ω:</strong> ${physics || '(Kh√¥ng c√≥ b√†i t·∫≠p)'}
- <strong style="color: #059669;">H√≥a:</strong> ${chemistry || '(Kh√¥ng c√≥ b√†i t·∫≠p)'}
- <strong style="color: #059669;">Sinh:</strong> ${biology || '(Kh√¥ng c√≥ b√†i t·∫≠p)'}`;
                homeworkDetailsText = `Ch√∫ng ta tu·∫ßn n√†y s·∫Ω l√†m b√†i t·∫≠p v·ªÅ nh√† c·ªßa 3 ph√¢n m√¥n nh∆∞ sau:
- L√Ω: ${physics || '(Kh√¥ng c√≥ b√†i t·∫≠p)'}
- H√≥a: ${chemistry || '(Kh√¥ng c√≥ b√†i t·∫≠p)'}
- Sinh: ${biology || '(Kh√¥ng c√≥ b√†i t·∫≠p)'}`;
            } else {
                const questions = document.getElementById('hwQuestionsInput').value.trim();
                homeworkDetails = `Ch√∫ng ta tu·∫ßn n√†y s·∫Ω l√†m <strong style="color: #E53E3E;">${questions} c√¢u</strong> b√†i t·∫≠p v·ªÅ nh√† c·ªßa ph√¢n m√¥n ${subject}`;
                homeworkDetailsText = `Ch√∫ng ta tu·∫ßn n√†y s·∫Ω l√†m ${questions} c√¢u b√†i t·∫≠p v·ªÅ nh√† c·ªßa ph√¢n m√¥n ${subject}`;
            }
            const link = document.getElementById('hwLinkInput').value.trim();
            const note = document.getElementById('hwNoteInput').value.trim();
            
            const announcementHTML = `üì¢ TH√îNG B√ÅO NH·∫ÆC NH·ªû B√ÄI T·∫¨P V·ªÄ NH√Ä
<strong style="color: #D97706;">l∆∞u √Ω quan tr·ªçng:</strong> ${note}
C√°c b·∫°n ∆°i. ${homeworkDetails}
Th·∫ßy nh·∫Øc l·∫°i: ƒê·ª´ng qu√™n ho√†n th√†nh b√†i t·∫≠p v·ªÅ nh√† ƒë√£ ƒë∆∞·ª£c giao trong bu·ªïi h·ªçc v·ª´a r·ªìi. ƒê√¢y l√† ph·∫ßn quan tr·ªçng gi√∫p c√°c em √¥n l·∫°i ki·∫øn th·ª©c v√† chu·∫©n b·ªã t·ªët cho ti·∫øt h·ªçc ti·∫øp theo.
üìù <strong style="color: #1D4ED8;">H·∫°n n·ªôp:</strong> ${deadlineText}
üìö C√°c b·∫°n nh·ªõ l√†m b√†i tr√™n web th·∫ßy g·ª≠i, h√£y ghi nh·ªõ ƒëi·ªÉm m·∫°nh v√† nh·ªØng c√¢u sai nh√°.
‚è∞ H√£y s·∫Øp x·∫øp th·ªùi gian h·ª£p l√Ω ƒë·ªÉ ho√†n th√†nh ƒë√∫ng h·∫°n nh√©!
N·∫øu c√≥ th·∫Øc m·∫Øc g√¨, c√°c em c√≥ th·ªÉ trao ƒë·ªïi tr·ª±c ti·∫øp v·ªõi th·∫ßy ho·∫∑c anh, ch·ªã tr·ª£ gi·∫£ng ho·∫∑c h·ªèi trong nh√≥m l·ªõp.
ƒë√¢y l√† link b√†i t·∫≠p v·ªÅ nh√† tu·∫ßn n√†y c·ªßa c√°c b·∫°n: <a href="${link}" target="_blank" style="color: #3B82F6; text-decoration: underline;">${link}</a>
Ph·ª• Huynh nh·∫Øc c√°c con l√†m b√†i gi√∫p th·∫ßy nha!!!`;

            const announcementText = `üì¢ TH√îNG B√ÅO NH·∫ÆC NH·ªû B√ÄI T·∫¨P V·ªÄ NH√Ä
l∆∞u √Ω quan tr·ªçng: ${note}
C√°c b·∫°n ∆°i. ${homeworkDetailsText}
Th·∫ßy nh·∫Øc l·∫°i: ƒê·ª´ng qu√™n ho√†n th√†nh b√†i t·∫≠p v·ªÅ nh√† ƒë√£ ƒë∆∞·ª£c giao trong bu·ªïi h·ªçc v·ª´a r·ªìi. ƒê√¢y l√† ph·∫ßn quan tr·ªçng gi√∫p c√°c em √¥n l·∫°i ki·∫øn th·ª©c v√† chu·∫©n b·ªã t·ªët cho ti·∫øt h·ªçc ti·∫øp theo.
üìù H·∫°n n·ªôp: ${deadlineText}
üìö C√°c b·∫°n nh·ªõ l√†m b√†i tr√™n web th·∫ßy g·ª≠i, h√£y ghi nh·ªõ ƒëi·ªÉm m·∫°nh v√† nh·ªØng c√¢u sai nh√°.
‚è∞ H√£y s·∫Øp x·∫øp th·ªùi gian h·ª£p l√Ω ƒë·ªÉ ho√†n th√†nh ƒë√∫ng h·∫°n nh√©!
N·∫øu c√≥ th·∫Øc m·∫Øc g√¨, c√°c em c√≥ th·ªÉ trao ƒë·ªïi tr·ª±c ti·∫øp v·ªõi th·∫ßy ho·∫∑c anh, ch·ªã tr·ª£ gi·∫£ng ho·∫∑c h·ªèi trong nh√≥m l·ªõp.
ƒë√¢y l√† link b√†i t·∫≠p v·ªÅ nh√† tu·∫ßn n√†y c·ªßa c√°c b·∫°n: ${link}
Ph·ª• Huynh nh·∫Øc c√°c con l√†m b√†i gi√∫p th·∫ßy nha!!!`;

            const resultTitle = `<div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">N·ªôi dung th√¥ng b√°o b√†i t·∫≠p:</h2>
                <button class="copy-btn text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-4 py-2" data-copy="${announcementText}">Sao ch√©p</button>
            </div>`;
            outputDiv.innerHTML = resultTitle + `<div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 whitespace-pre-wrap text-sm">${announcementHTML}</div>`;
            resultContainer.style.display = 'block';
        });

        // --- Session Feedback Logic (REBUILT) ---
        const btnLoadSheetData = document.getElementById('btnLoadSheetData');
        const loadBtnText = document.getElementById('loadBtnText');
        const loadLoader = document.getElementById('loadLoader');
        const fbStep2 = document.getElementById('fb-step2');
        const fbSheetSelect = document.getElementById('fbSheetSelect');
        const fbNameColumnSelect = document.getElementById('fbNameColumnSelect');
        const fbScoreColumnSelect = document.getElementById('fbScoreColumnSelect');
        const fbTotalQuestionsColumnSelect = document.getElementById('fbTotalQuestionsColumnSelect');
        const generateBtnFeedback = document.getElementById('generateBtnFeedback');
        const feedbackBtnText = document.getElementById('feedbackBtnText');
        const feedbackLoader = document.getElementById('feedbackLoader');
        let sheetMetadata = {};

        btnLoadSheetData.addEventListener('click', async () => {
            const sheetUrl = document.getElementById('fbSheetLink').value.trim();
            if (!sheetUrl) {
                showCustomAlert('Vui l√≤ng nh·∫≠p link Google Sheet.', 'error');
                return;
            }

            loadBtnText.textContent = 'ƒêang t·∫£i...';
            loadLoader.style.display = 'inline-block';
            btnLoadSheetData.disabled = true;
            fbStep2.classList.add('hidden');
            generateBtnFeedback.disabled = true;

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getSheetMetadata', sheetUrl }),
                    redirect: 'follow'
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                sheetMetadata = data.metadata;
                const sheetNames = Object.keys(sheetMetadata);
                
                if (sheetNames.length === 0) {
                    showCustomAlert('Kh√¥ng t√¨m th·∫•y sheet n√†o trong file.', 'error');
                    return;
                }

                fbSheetSelect.innerHTML = '';
                sheetNames.forEach(name => {
                    const option = new Option(name, name);
                    fbSheetSelect.add(option);
                });

                updateColumnSelectors();
                fbStep2.classList.remove('hidden');
                generateBtnFeedback.disabled = false;
                showCustomAlert('T·∫£i th√¥ng tin Sheet th√†nh c√¥ng!', 'success');

            } catch (error) {
                showCustomAlert(`L·ªói khi t·∫£i d·ªØ li·ªáu Sheet: ${error.message}`, 'error');
            } finally {
                loadBtnText.textContent = 'T·∫£i th√¥ng tin Sheet';
                loadLoader.style.display = 'none';
                btnLoadSheetData.disabled = false;
            }
        });

        fbSheetSelect.addEventListener('change', updateColumnSelectors);

        function updateColumnSelectors() {
            const selectedSheet = fbSheetSelect.value;
            const columns = sheetMetadata[selectedSheet] || [];
            
            fbNameColumnSelect.innerHTML = '';
            fbScoreColumnSelect.innerHTML = '';
            fbTotalQuestionsColumnSelect.innerHTML = '';

            columns.forEach(col => {
                fbNameColumnSelect.add(new Option(col, col));
                fbScoreColumnSelect.add(new Option(col, col));
                fbTotalQuestionsColumnSelect.add(new Option(col, col));
            });
        }

        // Function to call Gemini API with exponential backoff
        async function callGeminiApiWithRetry(prompt, apiKey, retries = 3, delay = 1000) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "generalComment": { "type": "STRING" },
                            "highScorerPraise": { "type": "STRING" },
                            "lowScorerEncouragement": { "type": "STRING" }
                        },
                        "required": ["generalComment", "highScorerPraise", "lowScorerEncouragement"]
                    }
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // If it's a server error (5xx) or rate limit (429), retry
                        if (response.status >= 500 || response.status === 429) {
                            console.warn(`Retry attempt ${i + 1} for Gemini API. Status: ${response.status}`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        } else {
                            // Other client-side errors, don't retry
                            throw new Error(`L·ªói Gemini API: ${response.status} - ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const json = result.candidates[0].content.parts[0].text;
                        return JSON.parse(json);
                    } else {
                        throw new Error("C·∫•u tr√∫c ph·∫£n h·ªìi t·ª´ Gemini API kh√¥ng mong mu·ªën.");
                    }
                } catch (error) {
                    if (i === retries - 1) { // Last retry failed
                        throw error;
                    }
                }
            }
            throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Gemini API sau nhi·ªÅu l·∫ßn th·ª≠.");
        }


        generateBtnFeedback.addEventListener('click', async () => {
            const subject = document.getElementById('fbSubject').value.trim();
            const lesson = document.getElementById('fbLesson').value.trim();
            const sheetUrl = document.getElementById('fbSheetLink').value.trim();
            const sheetName = fbSheetSelect.value;
            const nameColumn = fbNameColumnSelect.value;
            const scoreColumn = fbScoreColumnSelect.value;
            const totalQuestionsColumn = fbTotalQuestionsColumnSelect.value;
            const useAI = document.getElementById('fbUseAI').checked;
            
            // Use the hardcoded API key
            const geminiApiKey = GEMINI_API_KEY; 
            
            if (!subject || !lesson || !sheetUrl || !sheetName || !nameColumn || !scoreColumn || !totalQuestionsColumn) {
                showCustomAlert('Vui l√≤ng ho√†n t·∫•t c√°c b∆∞·ªõc v√† l·ª±a ch·ªçn.', 'error');
                return;
            }

            // No need to check geminiApiKey if it's hardcoded, but you might want to check if it's empty
            if (useAI && (!geminiApiKey || geminiApiKey === "YOUR_GEMINI_API_KEY_HERE")) {
                showCustomAlert('API Key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh ho·∫∑c kh√¥ng h·ª£p l·ªá trong m√£ ngu·ªìn. Vui l√≤ng thay th·∫ø "YOUR_GEMINI_API_KEY_HERE" b·∫±ng API Key th·ª±c c·ªßa b·∫°n.', 'error');
                return;
            }

            feedbackBtnText.textContent = 'ƒêang ph√¢n t√≠ch...';
            feedbackLoader.style.display = 'inline-block';
            generateBtnFeedback.disabled = true;
            
            try {
                // Step 1: Get data from Google Apps Script (backend)
                const backendPayload = {
                    action: 'analyzeSheet',
                    subject,
                    lesson,
                    sheetUrl,
                    sheetName,
                    nameColumn,
                    scoreColumn,
                    totalQuestionsColumn,
                    useAI: false // Always set to false for backend, as AI is now handled frontend
                };

                const backendResponse = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(backendPayload),
                    redirect: 'follow'
                });

                if (!backendResponse.ok) throw new Error(`L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß backend: ${backendResponse.status}`);
                let data = await backendResponse.json();
                if (data.error) throw new Error(data.error);

                let generalComment = data.generalComment;
                let highScorerPraise = data.highScorerPraise;
                let lowScorerEncouragement = data.lowScorerEncouragement;

                // Step 2: If AI is enabled, call Gemini API from frontend
                if (useAI) {
                    feedbackBtnText.textContent = 'ƒêang t·∫°o nh·∫≠n x√©t AI...';
                    // Updated prompt to explicitly ask for JSON only and adopt teacher persona
                    const prompt = `B·∫°n l√† m·ªôt th·∫ßy gi√°o. D·ª±a tr√™n th√¥ng tin bu·ªïi h·ªçc v√† k·∫øt qu·∫£ c·ªßa h·ªçc sinh, h√£y t·∫°o m·ªôt nh·∫≠n x√©t chung v·ªÅ bu·ªïi h·ªçc, m·ªôt l·ªùi khen ng·ª£i cho h·ªçc sinh ƒëi·ªÉm cao v√† m·ªôt l·ªùi ƒë·ªông vi√™n cho h·ªçc sinh c·∫ßn c·ªë g·∫Øng th√™m.
M√¥n h·ªçc: ${subject}
B√†i h·ªçc: ${lesson}
ƒêi·ªÉm trung b√¨nh: ${data.averageScore}%
ƒêi·ªÉm trung v·ªã: ${data.medianScore}%
5 h·ªçc sinh ƒëi·ªÉm cao nh·∫•t: ${data.topStudents.join(', ')}
3 h·ªçc sinh ƒëi·ªÉm th·∫•p nh·∫•t: ${data.bottomStudents.join(', ')}

Ch·ªâ tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng JSON v·ªõi c√°c tr∆∞·ªùng: "generalComment", "highScorerPraise", "lowScorerEncouragement". Kh√¥ng c√≥ vƒÉn b·∫£n n√†o kh√°c ngo√†i JSON.`;

                    try {
                        const aiComments = await callGeminiApiWithRetry(prompt, geminiApiKey);
                        generalComment = aiComments.generalComment;
                        highScorerPraise = aiComments.highScorerPraise;
                        lowScorerEncouragement = aiComments.lowScorerEncouragement;
                        showCustomAlert('Nh·∫≠n x√©t AI ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');
                    } catch (aiError) {
                        console.error("L·ªói khi g·ªçi Gemini API:", aiError);
                        showCustomAlert(`L·ªói khi t·∫°o nh·∫≠n x√©t AI: ${aiError.message}. S·ª≠ d·ª•ng nh·∫≠n x√©t m·∫∑c ƒë·ªãnh.`, 'error');
                        // Fallback to backend's default comments if AI generation fails
                        // The 'data' object already contains default comments from the backend call
                    }
                }
                
                const fullReportText = `Th·∫ßy gi√°o xin g·ª≠i ƒëi·ªÉm s·ªë v√† nh·∫≠n x√©t c·ªßa bu·ªïi h·ªçc m√¥n ${subject} b√†i: ${lesson}\n\n` +
                                        `‚úÖ 5 H·ªçc sinh c√≥ ƒëi·ªÉm cao nh·∫•t:\n${data.topStudents.join('\n')}\n\n` +
                                        `üÜò 3 h·ªçc sinh c√≥ ƒëi·ªÉm th·∫•p nh·∫•t:\n${data.bottomStudents.join('\n')}\n\n` +
                                        `--- TH·ªêNG K√ä CHUNG ---\n` +
                                        `- ƒêi·ªÉm trung b√¨nh: ${data.averageScore}%\n` +
                                        `- ƒêi·ªÉm trung v·ªã: ${data.medianScore}%\n\n` +
                                        `--- NH·∫¨N X√âT C·ª¶A GI√ÅO VI√äN ---\n${generalComment}\n\n` +
                                        `-> G·ª≠i c√°c b·∫°n ƒëi·ªÉm cao: ${highScorerPraise}\n` +
                                        `-> G·ª≠i c√°c b·∫°n c·∫ßn c·ªë g·∫Øng th√™m: ${lowScorerEncouragement}`;

                const feedbackHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Nh·∫≠n x√©t bu·ªïi h·ªçc m√¥n ${subject}</h2>
                        <button class="copy-btn text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-4 py-2" data-copy="${fullReportText}">Sao ch√©p t·∫•t c·∫£</button>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 space-y-4 text-sm">
                        <p>Th·∫ßy gi√°o xin g·ª≠i ƒëi·ªÉm s·ªë v√† nh·∫≠n x√©t c·ªßa bu·ªïi h·ªçc m√¥n <strong>${subject}</strong> b√†i: <strong>${lesson}</strong></p>
                        <div>
                            <h3 class="font-semibold text-green-600">‚úÖ 5 H·ªçc sinh c√≥ ƒëi·ªÉm cao nh·∫•t:</h3>
                            <ul class="list-disc list-inside ml-4">${data.topStudents.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                        <div>
                            <h3 class="font-semibold text-red-600">üÜò 3 h·ªçc sinh c√≥ ƒëi·ªÉm th·∫•p nh·∫•t:</h3>
                            <ul class="list-disc list-inside ml-4">${data.bottomStudents.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                        <div>
                            <h3 class="font-semibold">üìä Th·ªëng k√™ chung:</h3>
                            <p>- <strong>ƒêi·ªÉm trung b√¨nh:</strong> ${data.averageScore}%</p>
                            <p>- <strong>ƒêi·ªÉm trung v·ªã:</strong> ${data.medianScore}%</p>
                        </div>
                        <div>
                            <h3 class="font-semibold">‚≠ê Nh·∫≠n x√©t c·ªßa gi√°o vi√™n:</h3>
                            <p class="mt-1 italic">"${generalComment}"</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-blue-600">üíå L·ªùi ƒë·ªông vi√™n:</h3>
                            <p class="mt-1 pl-4 border-l-2 border-green-500"><strong>G·ª≠i c√°c b·∫°n ƒëi·ªÉm cao:</strong> ${highScorerPraise}</p>
                            <p class="mt-2 pl-4 border-l-2 border-orange-500"><strong>G·ª≠i c√°c b·∫°n c·∫ßn c·ªë g·∫Øng th√™m:</strong> ${lowScorerEncouragement}</p>
                        </div>
                    </div>`;

                outputDiv.innerHTML = feedbackHTML;
                resultContainer.style.display = 'block';
                showCustomAlert('ƒê√£ t·∫°o nh·∫≠n x√©t th√†nh c√¥ng!', 'success');

            } catch (error) {
                outputDiv.innerHTML = `<h2 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-4">ƒê√£ x·∫£y ra l·ªói</h2>
                <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg">
                    <p><strong>Kh√¥ng th·ªÉ ph√¢n t√≠ch.</strong></p>
                    <p class="mt-2"><strong>Chi ti·∫øt l·ªói:</strong> ${error.message}</p>
                    <p class="mt-4 text-sm"><strong>G·ª£i √Ω:</strong>
                        <ul class="list-disc list-inside mt-1">
                            <li>Ki·ªÉm tra l·∫°i link Google Sheet ƒëi·ªÉm ƒë√£ ch√≠nh x√°c v√† ƒë√£ ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.</li>
                            <li>ƒê·∫£m b·∫£o b·∫°n ƒë√£ ch·ªçn ƒë√∫ng Sheet v√† c√°c c·ªôt d·ªØ li·ªáu.</li>
                            <li>ƒê·∫£m b·∫£o b·∫°n ƒë√£ tri·ªÉn khai l·∫°i file Apps Script sau khi c·∫≠p nh·∫≠t.</li>
                            <li>N·∫øu s·ª≠ d·ª•ng AI, h√£y ki·ªÉm tra l·∫°i Gemini API Key.</li>
                        </ul>
                    </p>
                </div>`;
                resultContainer.style.display = 'block';
                showCustomAlert('L·ªói khi t·∫°o nh·∫≠n x√©t.', 'error');
            } finally {
                feedbackBtnText.textContent = 'Ph√¢n t√≠ch v√† t·∫°o nh·∫≠n x√©t';
                feedbackLoader.style.display = 'none';
                generateBtnFeedback.disabled = false;
            }
        });

        // --- Update Lecture Logic ---
        const btnUpdateLecture = document.getElementById('btnUpdateLecture');
        const updateBtnText = document.getElementById('updateBtnText');
        const updateLoader = document.getElementById('updateLoader');
        const updateDateInput = document.getElementById('updateDate');
        if (updateDateInput) {
            updateDateInput.valueAsDate = new Date();
        }

        if (btnUpdateLecture) {
            btnUpdateLecture.addEventListener('click', async () => {
                const classId = document.getElementById('updateClass').value;
                const subject = document.getElementById('updateSubject').value;
                const content = document.getElementById('updateContent').value.trim();
                const date = document.getElementById('updateDate').value;
                const lectureLink = document.getElementById('updateLectureLink').value.trim();
                const videoLink = document.getElementById('updateVideoLink').value.trim();
                const homeworkLink = document.getElementById('updateHomeworkLink').value.trim();

                if (!classId || !subject || !content || !date || !lectureLink) {
                    showCustomAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc.', 'error');
                    return;
                }

                updateBtnText.textContent = 'ƒêang c·∫≠p nh·∫≠t...';
                updateLoader.style.display = 'inline-block';
                btnUpdateLecture.disabled = true;

                try {
                    const response = await fetch(backendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'updateLecture', // Specify the action
                            classId,
                            subject,
                            content,
                            date,
                            lectureLink,
                            videoLink,
                            homeworkLink
                        }),
                        redirect: 'follow'
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    
                    showCustomAlert(data.message, 'success'); // Show success message
                    // Clear fields after successful update
                    document.getElementById('updateContent').value = '';
                    document.getElementById('updateLectureLink').value = '';
                    document.getElementById('updateVideoLink').value = '';
                    document.getElementById('updateHomeworkLink').value = '';

                } catch (error) {
                    showCustomAlert('L·ªói khi c·∫≠p nh·∫≠t: ' + error.message, 'error');
                } finally {
                    updateBtnText.textContent = 'Up b√†i gi·∫£ng';
                    updateLoader.style.display = 'none';
                    btnUpdateLecture.disabled = false;
                }
            });
        }

        // --- Check Homework Logic ---
        const btnCheckHw = document.getElementById('btnCheckHw');
        const checkHwBtnText = document.getElementById('checkHwBtnText');
        const checkHwLoader = document.getElementById('checkHwLoader');
        const checkHwClassSelect = document.getElementById('checkHwClassSelect');

        async function populateClassSelector() {
            if (!checkHwClassSelect) return;
            // Only fetch if options are not already loaded or if it's disabled (meaning it needs a refresh)
            if (checkHwClassSelect.options.length > 1 && !checkHwClassSelect.disabled) return; 
            
            checkHwClassSelect.innerHTML = '<option>ƒêang t·∫£i danh s√°ch l·ªõp...</option>';
            checkHwClassSelect.disabled = true;
            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getSheetNames' }),
                    redirect: 'follow'
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                const sheetNames = data.sheetNames;
                checkHwClassSelect.innerHTML = '';
                if (sheetNames && sheetNames.length > 0) {
                    sheetNames.forEach(name => {
                        const option = new Option(name, name);
                        checkHwClassSelect.appendChild(option);
                    });
                } else {
                    checkHwClassSelect.innerHTML = '<option>Kh√¥ng t√¨m th·∫•y l·ªõp n√†o</option>';
                }
            } catch (error) {
                checkHwClassSelect.innerHTML = `<option>L·ªói khi t·∫£i danh s√°ch</option>`;
                console.error("L·ªói khi t·∫£i danh s√°ch l·ªõp:", error);
                showCustomAlert('L·ªói khi t·∫£i danh s√°ch l·ªõp.', 'error');
            } finally {
                checkHwClassSelect.disabled = false;
            }
        }

        if (btnCheckHw) {
            btnCheckHw.addEventListener('click', async () => {
                const className = checkHwClassSelect.value;
                const scoreSheetUrl = document.getElementById('checkHwScoreSheet').value.trim();
                if (!className || !scoreSheetUrl || checkHwClassSelect.disabled) {
                    showCustomAlert('Vui l√≤ng ch·ªçn l·ªõp v√† ƒëi·ªÅn link Google Sheet ƒëi·ªÉm.', 'error');
                    return;
                }
                checkHwBtnText.textContent = 'ƒêang ki·ªÉm tra...';
                checkHwLoader.style.display = 'inline-block';
                btnCheckHw.disabled = true;
                try {
                    const response = await fetch(backendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'checkHomework',
                            className,
                            scoreSheetUrl
                        }),
                        redirect: 'follow'
                    });
                    if (!response.ok) throw new Error(`L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    const missingStudents = data.missingStudents;
                    let resultHTML = `<h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">K·∫øt qu·∫£ ki·ªÉm tra b√†i t·∫≠p v·ªÅ nh√†:</h2>`;
                    if (missingStudents.length > 0) {
                        resultHTML += `<p class="mb-4">C√≥ <strong>${missingStudents.length}</strong> h·ªçc sinh ch∆∞a n·ªôp b√†i:</p>`;
                        missingStudents.forEach(student => {
                            resultHTML += `
                            <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 mb-4">
                                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${student.name}</h3>
                                <div class="mt-3 space-y-3 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span>Zalo PH: ${student.parentZalo || 'Ch∆∞a c√≥'}</span>
                                        <button class="copy-btn text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" data-copy="${student.parentZalo}">Ch√©p SƒêT</button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Zalo HS: ${student.studentZalo || 'Ch∆∞a c√≥'}</span>
                                        <button class="copy-btn text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" data-copy="${student.studentZalo}">Ch√©p SƒêT</button>
                                    </div>
                                    <div class="pt-2">
                                        <label class="block font-medium text-gray-700 dark:text-gray-300">Tin nh·∫Øn cho ph·ª• huynh:</label>
                                        <div class="flex items-start mt-1">
                                            <textarea readonly class="w-full h-20 p-2 bg-white dark:bg-gray-800 rounded-md text-xs">${student.parentMsg}</textarea>
                                            <button class="copy-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded ml-2" data-copy="${student.parentMsg}">Ch√©p tin</button>
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <label class="block font-medium text-gray-700 dark:text-gray-300">Tin nh·∫Øn cho h·ªçc sinh:</label>
                                        <div class="flex items-start mt-1">
                                            <textarea readonly class="w-full h-20 p-2 bg-white dark:bg-gray-800 rounded-md text-xs">${student.studentMsg}</textarea>
                                            <button class="copy-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded ml-2" data-copy="${student.studentMsg}">Ch√©p tin</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        });
                        showCustomAlert(`C√≥ ${missingStudents.length} h·ªçc sinh ch∆∞a n·ªôp b√†i.`, 'info');
                    } else {
                        resultHTML += '<p class="text-green-600 font-semibold">üéâ Ch√∫c m·ª´ng! T·∫•t c·∫£ h·ªçc sinh ƒë√£ n·ªôp b√†i.</p>';
                        showCustomAlert('T·∫•t c·∫£ h·ªçc sinh ƒë√£ n·ªôp b√†i!', 'success');
                    }
                    outputDiv.innerHTML = resultHTML;
                    resultContainer.style.display = 'block';
                } catch (error) {
                    outputDiv.innerHTML = `<h2 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-4">ƒê√£ x·∫£y ra l·ªói</h2>
                    <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg">
                        <p><strong>Kh√¥ng th·ªÉ l·∫•y k·∫øt qu·∫£.</strong></p>
                        <p class="mt-2"><strong>Chi ti·∫øt l·ªói:</strong> ${error.message}</p>
                        <p class="mt-4 text-sm"><strong>G·ª£i √Ω:</strong>
                            <ul class="list-disc list-inside mt-1">
                                <li>Ki·ªÉm tra l·∫°i link Google Sheet ƒëi·ªÉm ƒë√£ ch√≠nh x√°c ch∆∞a.</li>
                                <li>ƒê·∫£m b·∫£o b·∫°n ƒë√£ tri·ªÉn khai l·∫°i file Apps Script sau khi c·∫≠p nh·∫≠t.</li>
                                <li>M·ªü file Google Sheet v√† ch·∫Øc ch·∫Øn r·∫±ng b·∫°n ƒë√£ c·∫•p quy·ªÅn cho script ho·∫°t ƒë·ªông.</li>
                            </ul>
                        </p>
                    </div>`;
                    resultContainer.style.display = 'block';
                    showCustomAlert('L·ªói khi ki·ªÉm tra b√†i t·∫≠p.', 'error');
                } finally {
                    checkHwBtnText.textContent = 'Ki·ªÉm tra';
                    checkHwLoader.style.display = 'none';
                    btnCheckHw.disabled = false;
                }
            });
        }

        // --- Low Score Iframe Logic ---
        const lowScoreFrame = document.getElementById('lowScoreFrame');
        const lowScoreHtmlContent = `
        <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• H·ªçc Sinh ƒêi·ªÉm Th·∫•p</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-content {
            display: block; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366F1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #customAlert {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(calc(100% + 20px));
            opacity: 0;
        }
        #customAlert.show {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8">
            
            <div class="text-center mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400">C√¥ng C·ª• H·ªçc Sinh ƒêi·ªÉm Th·∫•p</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">T√¨m v√† li√™n h·ªá h·ªçc sinh c√≥ ƒëi·ªÉm b√†i t·∫≠p d∆∞·ªõi 7.</p>
            </div>

            <div id="tabContentLowScoreHw" class="tab-content active fade-in">
                <div class="space-y-6">
                    <div>
                        <label for="lowScoreHwClassSelect" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Ch·ªçn l·ªõp</label>
                        <select id="lowScoreHwClassSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" disabled>
                            <option>ƒêang t·∫£i danh s√°ch l·ªõp...</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Ch·ªçn l·ªõp ƒë·ªÉ l·∫•y th√¥ng tin Zalo t·ª´ file d·ªØ li·ªáu l·ªõp ch√≠nh.</p>
                    </div>
                    
                    <div>
                        <label for="lowScoreHwSheetLink" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Link Google Sheet ƒêi·ªÉm B√†i T·∫≠p</label>
                        <input type="url" id="lowScoreHwSheetLink" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="D√°n link file ƒëi·ªÉm b√†i t·∫≠p v·ªÅ nh√†" required>
                    </div>
                    <div class="text-right">
                        <button id="btnLoadLowScoreSheetData" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 inline-flex items-center">
                            <span id="loadLowScoreBtnText">T·∫£i th√¥ng tin Sheet</span>
                            <div id="loadLowScoreLoader" class="loader ml-2" style="display: none;"></div>
                        </button>
                    </div>

                    <div id="lowScoreHwStep2" class="hidden space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">Ch·ªçn d·ªØ li·ªáu ph√¢n t√≠ch t·ª´ Sheet ƒêi·ªÉm B√†i T·∫≠p</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="lowScoreHwSheetSelect" class="block mb-2 text-sm font-medium">Ch·ªçn Sheet ch·ª©a ƒëi·ªÉm b√†i t·∫≠p</label>
                                <select id="lowScoreHwSheetSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                            <div>
                                <label for="lowScoreHwNameColumnSelect" class="block mb-2 text-sm font-medium">C·ªôt T√™n h·ªçc sinh (trong sheet ƒëi·ªÉm)</label>
                                <select id="lowScoreHwNameColumnSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                            <div>
                                <label for="lowScoreHwScoreColumnSelect" class="block mb-2 text-sm font-medium">C·ªôt S·ªë c√¢u ƒë√∫ng</label>
                                <select id="lowScoreHwScoreColumnSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                            <div>
                                <label for="lowScoreHwTotalQuestionsColumnSelect" class="block mb-2 text-sm font-medium">C·ªôt T·ªïng s·ªë c√¢u</label>
                                <select id="lowScoreHwTotalQuestionsColumnSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="btnAnalyzeLowScores" class="w-full sm:w-auto text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-6 py-3 text-center inline-flex items-center disabled:bg-gray-400">
                        <span id="analyzeLowScoresBtnText">Ph√¢n t√≠ch ƒëi·ªÉm th·∫•p</span>
                        <div id="analyzeLowScoresLoader" class="loader ml-3" style="display: none;"></div>
                    </button>
                </div>
            </div>


            <div id="resultContainer" class="mt-10" style="display: none;">
                <div id="output"></div>
                <div id="copyMessage" class="mt-2 text-center text-green-600 dark:text-green-400 font-medium" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="customAlert" class="fixed bottom-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center space-x-3 z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="customAlertMessage"></span>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const lowScoreHwClassSelect = document.getElementById('lowScoreHwClassSelect');
        const btnLoadLowScoreSheetData = document.getElementById('btnLoadLowScoreSheetData');
        const loadLowScoreBtnText = document.getElementById('loadLowScoreBtnText');
        const loadLowScoreLoader = document.getElementById('loadLowScoreLoader');
        const lowScoreHwStep2 = document.getElementById('lowScoreHwStep2');
        const lowScoreHwSheetSelect = document.getElementById('lowScoreHwSheetSelect');
        const lowScoreHwNameColumnSelect = document.getElementById('lowScoreHwNameColumnSelect');
        const lowScoreHwScoreColumnSelect = document.getElementById('lowScoreHwScoreColumnSelect');
        const lowScoreHwTotalQuestionsColumnSelect = document.getElementById('lowScoreHwTotalQuestionsColumnSelect');
        const btnAnalyzeLowScores = document.getElementById('btnAnalyzeLowScores');
        const analyzeLowScoresBtnText = document.getElementById('analyzeLowScoresBtnText');
        const analyzeLowScoresLoader = document.getElementById('analyzeLowScoresLoader');
        let lowScoreSheetMetadata = {};
        
        const resultContainer = document.getElementById('resultContainer');
        const outputDiv = document.getElementById('output');
        const copyMessage = document.getElementById('copyMessage');

        const backendUrl = "https://script.google.com/macros/s/AKfycbz3t_hcp0PAdTY4z1DeAVDbRiRDG7gDnBODBjfUXhVwY12IxAER0oWuONIEAhTIwKNF5Q/exec";
        const MASTER_DATA_SHEET_ID = "12erfMYULjLAdCmL4x8Q-ZX_X4d3SAgohQA5hGrCa0SU";
        const DEFAULT_MASTER_NAME_COL = "H·ªç v√† t√™n";
        const DEFAULT_PARENT_ZALO_COL = "Zalo ph·ª• huynh";
        const DEFAULT_STUDENT_ZALO_COL = "Zalo h·ªçc sinh";

        function showCustomAlert(message, type = 'info') {
            const alertBox = document.getElementById('customAlert');
            const alertMessage = document.getElementById('customAlertMessage');
            const alertIcon = alertBox.querySelector('svg');
            alertMessage.textContent = message;
            alertBox.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600');
            alertIcon.innerHTML = '';
            if (type === 'success') {
                alertBox.classList.add('bg-green-600');
                alertIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            } else if (type === 'error') {
                alertBox.classList.add('bg-red-600');
                alertIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            } else {
                alertBox.classList.add('bg-blue-600');
                alertIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            }
            alertBox.classList.add('show');
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 3000);
        }

        function copyToClipboard(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = button.innerHTML;
                button.innerHTML = 'ƒê√£ ch√©p!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 1500);
                showCustomAlert('ƒê√£ sao ch√©p v√†o clipboard!', 'success');
            } catch (err) {
                showCustomAlert('Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông.', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        outputDiv.addEventListener('click', function(e) {
            if (e.target && e.target.matches('button.copy-btn')) {
                const textToCopy = e.target.dataset.copy;
                copyToClipboard(textToCopy, e.target);
            }
        });

        async function populateLowScoreClassSelect() {
            if (!lowScoreHwClassSelect) return;
            lowScoreHwClassSelect.innerHTML = '<option>ƒêang t·∫£i danh s√°ch l·ªõp...</option>';
            lowScoreHwClassSelect.disabled = true;
            try {
                const responseClasses = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getSheetNames', spreadsheetId: MASTER_DATA_SHEET_ID }),
                    redirect: 'follow'
                });
                const dataClasses = await responseClasses.json();
                if (dataClasses.error) throw new Error(dataClasses.error);
                const sheetNames = dataClasses.sheetNames;
                lowScoreHwClassSelect.innerHTML = '';
                if (sheetNames && sheetNames.length > 0) {
                    sheetNames.forEach(name => {
                        const option = new Option(name, name);
                        lowScoreHwClassSelect.appendChild(option);
                    });
                } else {
                    lowScoreHwClassSelect.innerHTML = '<option>Kh√¥ng t√¨m th·∫•y l·ªõp n√†o</option>';
                }
            } catch (error) {
                lowScoreHwClassSelect.innerHTML = \`<option>L·ªói khi t·∫£i danh s√°ch</option>\`;
                console.error("L·ªói khi t·∫£i danh s√°ch l·ªõp:", error);
                showCustomAlert('L·ªói khi t·∫£i danh s√°ch l·ªõp.', 'error');
            } finally {
                lowScoreHwClassSelect.disabled = false;
            }
        }

        btnLoadLowScoreSheetData.addEventListener('click', async () => {
            const sheetUrl = document.getElementById('lowScoreHwSheetLink').value.trim();
            if (!sheetUrl) {
                showCustomAlert('Vui l√≤ng nh·∫≠p link Google Sheet ƒëi·ªÉm b√†i t·∫≠p.', 'error');
                return;
            }
            loadLowScoreBtnText.textContent = 'ƒêang t·∫£i...';
            loadLowScoreLoader.style.display = 'inline-block';
            btnLoadLowScoreSheetData.disabled = true;
            lowScoreHwStep2.classList.add('hidden');
            btnAnalyzeLowScores.disabled = true;
            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getSheetMetadata', sheetUrl }),
                    redirect: 'follow'
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                lowScoreSheetMetadata = data.metadata;
                const sheetNames = Object.keys(lowScoreSheetMetadata);
                if (sheetNames.length === 0) {
                    showCustomAlert('Kh√¥ng t√¨m th·∫•y sheet n√†o trong file.', 'error');
                    return;
                }
                lowScoreHwSheetSelect.innerHTML = '';
                sheetNames.forEach(name => {
                    const option = new Option(name, name);
                    lowScoreHwSheetSelect.add(option);
                });
                const selectedSheet = lowScoreHwSheetSelect.value;
                const columns = lowScoreSheetMetadata[selectedSheet] || [];
                lowScoreHwNameColumnSelect.innerHTML = '';
                lowScoreHwScoreColumnSelect.innerHTML = '';
                lowScoreHwTotalQuestionsColumnSelect.innerHTML = '';
                columns.forEach(col => {
                    lowScoreHwNameColumnSelect.add(new Option(col, col));
                    lowScoreHwScoreColumnSelect.add(new Option(col, col));
                    lowScoreHwTotalQuestionsColumnSelect.add(new Option(col, col));
                });
                lowScoreHwStep2.classList.remove('hidden');
                btnAnalyzeLowScores.disabled = false;
                showCustomAlert('T·∫£i th√¥ng tin Sheet th√†nh c√¥ng!', 'success');
            } catch (error) {
                showCustomAlert(\`L·ªói khi t·∫£i d·ªØ li·ªáu Sheet: \${error.message}\`, 'error');
            } finally {
                loadLowScoreBtnText.textContent = 'T·∫£i th√¥ng tin Sheet';
                loadLowScoreLoader.style.display = 'none';
                btnLoadLowScoreSheetData.disabled = false;
            }
        });

        lowScoreHwSheetSelect.addEventListener('change', () => {
            const selectedSheet = lowScoreHwSheetSelect.value;
            const columns = lowScoreSheetMetadata[selectedSheet] || [];
            lowScoreHwNameColumnSelect.innerHTML = '';
            lowScoreHwScoreColumnSelect.innerHTML = '';
            lowScoreHwTotalQuestionsColumnSelect.innerHTML = '';
            columns.forEach(col => {
                lowScoreHwNameColumnSelect.add(new Option(col, col));
                lowScoreHwScoreColumnSelect.add(new Option(col, col));
                lowScoreHwTotalQuestionsColumnSelect.add(new Option(col, col));
            });
        });

        btnAnalyzeLowScores.addEventListener('click', async () => {
            const selectedClassName = lowScoreHwClassSelect.value;
            const homeworkSheetUrl = document.getElementById('lowScoreHwSheetLink').value.trim();
            const homeworkSheetName = lowScoreHwSheetSelect.value;
            const nameColHw = lowScoreHwNameColumnSelect.value;
            const scoreColHw = lowScoreHwScoreColumnSelect.value;
            const totalQuestionsColHw = lowScoreHwTotalQuestionsColumnSelect.value;
            const nameColMaster = DEFAULT_MASTER_NAME_COL;
            const parentZaloColMaster = DEFAULT_PARENT_ZALO_COL;
            const studentZaloColMaster = DEFAULT_STUDENT_ZALO_COL;
            if (!selectedClassName || !homeworkSheetUrl || !homeworkSheetName || !nameColHw || !scoreColHw || !totalQuestionsColHw) {
                showCustomAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc v√† ch·ªçn c·ªôt.', 'error');
                return;
            }
            analyzeLowScoresBtnText.textContent = 'ƒêang ph√¢n t√≠ch...';
            analyzeLowScoresLoader.style.display = 'inline-block';
            btnAnalyzeLowScores.disabled = true;
            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'getHomeworkScores',
                        masterSpreadsheetId: MASTER_DATA_SHEET_ID,
                        selectedClassName: selectedClassName,
                        homeworkSheetUrl: homeworkSheetUrl,
                        homeworkSheetName: homeworkSheetName,
                        nameColHw: nameColHw,
                        scoreColHw: scoreColHw,
                        totalQuestionsColHw: totalQuestionsColHw,
                        nameColMaster: nameColMaster,
                        parentZaloColMaster: parentZaloColMaster,
                        studentZaloColMaster: studentZaloColMaster
                    }),
                    redirect: 'follow'
                });
                if (!response.ok) throw new Error(\`L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß: \${response.status}\`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                const lowScoreStudents = data.filter(student => {
                    const score = parseFloat(student.score);
                    const totalQuestions = parseFloat(student.totalQuestions);
                    if (isNaN(score) || isNaN(totalQuestions) || totalQuestions === 0) return false;
                    return (score / totalQuestions * 10) < 7;
                });
                let resultHTML = \`<h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">H·ªçc sinh c√≥ ƒëi·ªÉm b√†i t·∫≠p d∆∞·ªõi 7:</h2>\`;
                if (lowScoreStudents.length > 0) {
                    resultHTML += \`<p class="mb-4">C√≥ <strong>\${lowScoreStudents.length}</strong> h·ªçc sinh c·∫ßn ch√∫ √Ω:</p>\`;
                    lowScoreStudents.forEach(student => {
                        const nameParts = student.name.trim().split(' ');
                        const firstName = nameParts[nameParts.length - 1];
                        const parentMsg = \`Anh/ch·ªã ∆°i, em th·∫•y ƒëi·ªÉm b√†i t·∫≠p v·ªÅ nh√† c·ªßa em \${firstName} h∆°i th·∫•p (\${(parseFloat(student.score) / parseFloat(student.totalQuestions) * 10).toFixed(1)}/10 ƒëi·ªÉm). Ch·ªã h·ªèi xem con c√≥ v·∫•n ƒë·ªÅ g√¨ khi·∫øn con g·∫∑p kh√≥ khƒÉn kh√¥ng ·∫°? R·∫•t mong ph·ª• huynh h·ªó tr·ª£ nh·∫Øc nh·ªü v√† c√πng t√¨m hi·ªÉu nguy√™n nh√¢n ƒë·ªÉ gi√∫p con ti·∫øn b·ªô h∆°n.\`;
                        const studentMsg = \`Th·∫ßy th·∫•y ƒëi·ªÉm BTVN c·ªßa em h∆°i th·∫•p nh·ªâ (\${(parseFloat(student.score) / parseFloat(student.totalQuestions) * 10).toFixed(1)}/10 ƒëi·ªÉm). C√≥ kh√≥ khƒÉn ·ªü ƒë√¢u kh√¥ng em? N·∫øu c√≥ b·∫•t k·ª≥ c√¢u n√†o ch∆∞a hi·ªÉu r√µ, ƒë·ª´ng ng·∫ßn ng·∫°i nh·∫Øn tin h·ªèi th·∫ßy ho·∫∑c c√°c anh ch·ªã tr·ª£ gi·∫£ng nh√©. C·ªë g·∫Øng l√™n em!\`;
                        resultHTML += \`
                        <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-lg text-red-600 dark:text-red-400">\${student.name} (\${(parseFloat(student.score) / parseFloat(student.totalQuestions) * 10).toFixed(1)}/10 ƒëi·ªÉm)</h3>
                            <div class="mt-3 space-y-3 text-sm">
                                <div class="flex items-center justify-between">
                                    <span>Zalo PH: \${student.parentZalo || 'Ch∆∞a c√≥'}</span>
                                    <button class="copy-btn text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" data-copy="\${student.parentZalo}">Ch√©p SƒêT</button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Zalo HS: \${student.studentZalo || 'Ch∆∞a c√≥'}</span>
                                    <button class="copy-btn text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" data-copy="\${student.studentZalo}">Ch√©p SƒêT</button>
                                </div>
                                <div class="pt-2">
                                    <label class="block font-medium text-gray-700 dark:text-gray-300">Tin nh·∫Øn cho ph·ª• huynh:</label>
                                    <div class="flex items-start mt-1">
                                        <textarea readonly class="w-full h-20 p-2 bg-white dark:bg-gray-800 rounded-md text-xs">\${parentMsg}</textarea>
                                        <button class="copy-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded ml-2" data-copy="\${parentMsg}">Ch√©p tin</button>
                                    </div>
                                </div>
                                <div class="pt-2">
                                    <label class="block font-medium text-gray-700 dark:text-gray-300">Tin nh·∫Øn cho h·ªçc sinh:</label>
                                    <div class="flex items-start mt-1">
                                        <textarea readonly class="w-full h-20 p-2 bg-white dark:bg-gray-800 rounded-md text-xs">\${studentMsg}</textarea>
                                        <button class="copy-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded ml-2" data-copy="\${studentMsg}">Ch√©p tin</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        \`;
                    });
                    showCustomAlert(\`T√¨m th·∫•y \${lowScoreStudents.length} h·ªçc sinh ƒëi·ªÉm th·∫•p.\`, 'info');
                } else {
                    resultHTML += '<p class="text-green-600 font-semibold">üéâ Ch√∫c m·ª´ng! Kh√¥ng c√≥ h·ªçc sinh n√†o d∆∞·ªõi 7 ƒëi·ªÉm trong b√†i t·∫≠p n√†y.</p>';
                    showCustomAlert('Kh√¥ng c√≥ h·ªçc sinh n√†o d∆∞·ªõi 7 ƒëi·ªÉm.', 'success');
                }
                outputDiv.innerHTML = resultHTML;
                resultContainer.style.display = 'block';
            } catch (error) {
                outputDiv.innerHTML = \`<h2 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-4">ƒê√£ x·∫£y ra l·ªói</h2>
                <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg">
                    <p><strong>Kh√¥ng th·ªÉ ph√¢n t√≠ch ƒëi·ªÉm th·∫•p.</strong></p>
                    <p class="mt-2"><strong>Chi ti·∫øt l·ªói:</strong> \${error.message}</p>
                    <p class="mt-4 text-sm"><strong>G·ª£i √Ω:</strong>
                        <ul class="list-disc list-inside mt-1">
                            <li>Ki·ªÉm tra l·∫°i link Google Sheet ƒëi·ªÉm ƒë√£ ch√≠nh x√°c v√† ƒë√£ ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.</li>
                            <li>ƒê·∫£m b·∫£o b·∫°n ƒë√£ ch·ªçn ƒë√∫ng Sheet v√† c√°c c·ªôt d·ªØ li·ªáu.</li>
                            <li>ƒê·∫£m b·∫£o c√°c c·ªôt ƒëi·ªÉm s·ªë v√† t·ªïng s·ªë c√¢u ch·ªâ ch·ª©a gi√° tr·ªã s·ªë h·ª£p l·ªá.</li>
                            <li>ƒê·∫£m b·∫£o b·∫°n ƒë√£ tri·ªÉn khai l·∫°i file Apps Script sau khi c·∫≠p nh·∫≠t v·ªõi action 'getHomeworkScores'.</li>
                        </ul>
                    </p>
                </div>\`;
                resultContainer.style.display = 'block';
                showCustomAlert('L·ªói khi ph√¢n t√≠ch ƒëi·ªÉm th·∫•p.', 'error');
            } finally {
                analyzeLowScoresBtnText.textContent = 'Ph√¢n t√≠ch ƒëi·ªÉm th·∫•p';
                analyzeLowScoresLoader.style.display = 'none';
                btnAnalyzeLowScores.disabled = false;
            }
        });
        populateLowScoreClassSelect();
    });
    <\/script>

</body>
</html>
        `;
        if (lowScoreFrame) {
            lowScoreFrame.srcdoc = lowScoreHtmlContent.replace(/\\`/g, '`').replace(/\\\$/g, '$');
        }

    });
    </script>

</body>
</html>
